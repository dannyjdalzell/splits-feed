name: Build staged splits (every 15m)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: normalize-merge
  cancel-in-progress: true

jobs:
  stage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: |
          python -m pip install --upgrade pip
          pip install pandas
      - name: Build staged CSV
        run: |
          python scripts/normalize_and_merge.py \
            --resolver       ./audit_out/resolved_games_final_v2.csv \
            --opponent_fills ./audit_out/opponent_filled.csv \
            --twitter        ./audit_out/twitter_resolved.csv \
            --stage          ./audit_out/splits_staged.csv \
            --report         ./audit_out/qa_report.md
      - name: Commit staged outputs
        run: |
          git config user.name  "splits-bot"
          git config user.email "actions@users.noreply.github.com"
          git add -f audit_out/splits_staged.csv audit_out/qa_report.md || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "ci: refresh staged splits [skip ci]"
            git push
          fi
