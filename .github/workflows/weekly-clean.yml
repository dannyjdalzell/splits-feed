name: Weekly Clean (manual)

on:
  workflow_dispatch: {}   # button-only (no schedule)

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib

      - name: Clear Google Sheet (keep header row)
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          SPLITS_TWEETS_SHEET_ID:     ${{ secrets.SPLITS_TWEETS_SHEET_ID }}
          SPLITS_TWEETS_TAB:          ${{ vars.SPLITS_TWEETS_TAB || 'Tweets' }}
        run: |
          python - <<'PY'
          import os, json
          from google.oauth2.service_account import Credentials
          from googleapiclient.discovery import build

          SHEET_ID  = os.environ["SPLITS_TWEETS_SHEET_ID"]
          SHEET_TAB = os.environ.get("SPLITS_TWEETS_TAB","Tweets")

          sa = json.loads(os.environ["GOOGLE_SERVICE_ACCOUNT_JSON"])
          creds = Credentials.from_service_account_info(sa, scopes=["https://www.googleapis.com/auth/spreadsheets"])
          svc = build("sheets","v4",credentials=creds)
          svc.spreadsheets().values().clear(
              spreadsheetId=SHEET_ID, range=f"{SHEET_TAB}!A2:Z", body={}
          ).execute()
          print("[CLEAR] sheet rows cleared (headers kept)")
          PY

      - name: Prune images/ older than 7 days and push
        run: |
          find images -type f -mtime +7 -print -delete || true
          git config user.email "bot@local"
          git config user.name  "splits-bot"
          git add -A images
          if git diff --cached --quiet; then
            echo "No images to prune."
            exit 0
          fi
          git commit -m "[housekeeping] prune old images (>7d)"
          git pull --rebase origin main || true
          git push origin HEAD:main
