name: OCR Splits

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"  # every 15 minutes

permissions:
  contents: write

concurrency:
  group: ocr_splits
  cancel-in-progress: false

env:
  TZ: America/Chicago
  OCR_PROFILES_FILE: scripts/ocr_profiles.yaml

jobs:
  ocr_splits:
    runs-on: ubuntu-latest
    env:
      SPLITS_TWEETS_SHEET_ID: ${{ secrets.SPLITS_TWEETS_SHEET_ID }}
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: System deps
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-eng

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Python deps
        run: |
          python -m pip install --upgrade pip
          pip install \
            gspread google-auth google-auth-oauthlib google-auth-httplib2 \
            requests beautifulsoup4 lxml pillow pytesseract opencv-python-headless \
            numpy pandas pyyaml python-dateutil

      - name: Sheets ingest (download tweet images)
        env:
          SPLITS_TWEETS_SHEET_ID: ${{ secrets.SPLITS_TWEETS_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: python3 scripts/sheets_ingest.py

      - name: Pregame scraper (Most Action / Consensus screenshots)
        run: python3 scripts/pregame_scraper.py

      - name: OCR images -> CSV rows
        env:
          PROFILES_PATH: ${{ env.OCR_PROFILES_FILE }}
        run: python3 scripts/splits_ocr.py

      - name: Merge & push splits.csv (dedupe, single header, race-safe)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name  "splits-bot"
          git config user.email "actions@users.noreply.github.com"

          # If OCR didn't produce a CSV, exit quietly
          if [ ! -f splits.csv ]; then
            echo "No splits.csv present, nothing to push."
            exit 0
          fi

          header="timestamp,league,away_team,home_team,market,tickets_pct,handle_pct,line,source"

          attempt=0
          max_attempts=5
          until [ $attempt -ge $max_attempts ]; do
            attempt=$((attempt+1))
            echo "=== Merge/push attempt $attempt/$max_attempts ==="

            # Keep our local OCR output
            cp -f splits.csv /tmp/local.csv

            # Always fetch latest remote
            git fetch origin main

            # Pull remote splits.csv (if it exists) to a temp file
            if git cat-file -e origin/main:splits.csv 2>/dev/null; then
              git show origin/main:splits.csv > /tmp/remote.csv
            else
              : > /tmp/remote.csv
            fi

            # Build body files (strip headers if present)
            { tail -n +2 /tmp/remote.csv 2>/dev/null || true; } > /tmp/remote.body
            { tail -n +2 /tmp/local.csv  2>/dev/null || true; } > /tmp/local.body

            # Rebuild merged CSV with ONE header + de-duplicated body (remote first, then local)
            printf "%s\n" "$header" > splits.csv
            awk 'NR==FNR{ if(!($0 in seen)){seen[$0]=1; print $0}; next} { if(!($0 in seen)){seen[$0]=1; print $0} }' \
                /tmp/remote.body /tmp/local.body >> splits.csv

            # Stage any CSVs we might have
            add_any=false
            for f in splits.csv splits_clean.csv splits_flagged.csv; do
              if [ -f "$f" ]; then git add "$f"; add_any=true; fi
            done

            # Nothing changed? We're done.
            if ! $add_any || git diff --cached --quiet; then
              echo "No changes to commit."
              exit 0
            fi

            # Commit our merge result
            git commit -m "OCR: append new split rows (merged, deduped)"

            # Try to push
            if git push origin HEAD:main; then
              echo "Push OK"
              exit 0
            fi

            echo "Push rejected (non-fast-forward). Reset to origin/main and retryâ€¦"
            # Drop local commit and retry cleanly against the latest origin/main
            git reset --hard origin/main
            sleep $((2*attempt))
          done

          echo "Push still failing after ${max_attempts} attempts."
          exit 1
